<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analyzer - Stock {{ stock_number }} of 10</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <!-- Progress Header -->
        <div class="progress-header">
            <h1>Stock Analysis</h1>
            <p class="progress">Stock {{ stock_number }} of 10</p>
            <p><b>Instructions:</b> Below is a table showing the past 10 days of data for a particular stock. You may also see an AI suggestion below, which you can choose to consider or ignore. Please select whether you would like to <i>buy more</i> of the stock or <i>hold</i> your current shares. In addition, please enter a number in the text box to indicate how confident you feel about your choice, where 1 means you are not confident at all and 10 means you are very confident. Once you finish analyzing all 10 stocks, you will be shown a completion code. Please copy that code and paste it into the MTurk task. Thank you for your participation!</p>        </div>

        <!-- Stock Data Table -->
        <div class="box">
            <h3>Historical Data of {{ stock_data.ticker }} (Last 10 Days)</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Open</th>
                            <th>High</th>
                            <th>Low</th>
                            <th>Close</th>
                            <th>Volume</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in range(stock_data.open|length) %}
                        <tr>
                            <td>{{ i + 1 }}</td>
                            <td>${{ "%.2f"|format(stock_data.open[i]) }}</td>
                            <td>${{ "%.2f"|format(stock_data.high[i]) }}</td>
                            <td>${{ "%.2f"|format(stock_data.low[i]) }}</td>
                            <td>${{ "%.2f"|format(stock_data.close[i]) }}</td>
                            <td>{{ "{:,}".format(stock_data.volume[i]|int) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- AI Suggestion Box (Only if show_ai is True) -->
        {% if show_ai %}
        <div class="box ai-box">
            <h3>ðŸ¤– AI Suggestion</h3>
            <div class="suggestion-content">
                <div class="suggestion-badge {{ stock_data.ai_suggestion|lower }}">
                    {{ stock_data.ai_suggestion }}
                </div>
                <div class="prediction-info">
                    <p><strong>AI Predicted Next Open:</strong> ${{ "%.2f"|format(stock_data.ai_prediction) }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Decision Section -->
        <div class="decision-section">
            <h3>What would you do?</h3>
            
            <!-- Confidence Input -->
            <div class="confidence-input">
                <label for="user_confidence">Confidence (1-10):</label>
                <p>Instructions: Enter an integer from 1 to 10 on how confident you are with your decision.</p>
                <input type="number" style="padding: 20px;" id="user_confidence" name="user_confidence" 
                       min="1" max="10" value="5" required>
            </div>

            <!-- Decision Buttons -->
            <div class="button-group">
                <button onclick="submitDecision('BUY'); return false;" class="btn btn-buy" type="button">
                    BUY
                </button>
                <button onclick="submitDecision('HOLD'); return false;" class="btn btn-hold" type="button">
                    HOLD
                </button>
            </div>
        </div>
    </div>

    <script>
        function submitDecision(decision) {
            const confidence = document.getElementById('user_confidence').value;
            
            // Validate confidence
            if (!confidence || confidence < 1 || confidence > 10) {
                alert('Please enter a confidence value between 1 and 10');
                return;
            }
            
            // Create form data
            const formData = new FormData();
            formData.append('stock_number', '{{ stock_number }}');
            formData.append('ticker', '{{ stock_data.ticker }}');
            formData.append('previous_open', '{{ stock_data.previous_open }}');
            formData.append('current_price', '{{ stock_data.current_price }}');
            
            {% if show_ai %}
            // Include AI data if in with_ai condition
            formData.append('ai_suggestion', '{{ stock_data.ai_suggestion }}');
            formData.append('ai_prediction', '{{ stock_data.ai_prediction }}');
            {% else %}
            // Send N/A values if in without_ai condition
            formData.append('ai_suggestion', 'N/A');
            formData.append('ai_prediction', '0');
            {% endif %}
            
            formData.append('user_decision', decision);
            formData.append('user_confidence', confidence);
            
            console.log('Submitting decision:', decision, 'with confidence:', confidence);
            
            // Disable buttons to prevent double submission
            document.querySelectorAll('.btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            });
            
            // Submit
            fetch('/decision', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    return response.json();
                }
            })
            .then(data => {
                if (data) {
                    console.log('Response:', data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting decision');
                // Re-enable buttons on error
                document.querySelectorAll('.btn').forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });
            });
        }
    </script>
</body>
</html>